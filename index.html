<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Panorama Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: contain; /* Prevents pull-to-refresh on mobile */
        }
        /* Style for the range slider track */
        input[type="range"]::-webkit-slider-runnable-track {
            background: #374151; /* gray-700 */
        }
        input[type="range"]::-moz-range-track {
            background: #374151; /* gray-700 */
        }
        /* Style for the range slider thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: #3b82f6; /* blue-500 */
            cursor: pointer;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 9999px;
            margin-top: -6px; /* Center the thumb on the track */
        }
        input[type="range"]::-moz-range-thumb {
            background: #3b82f6; /* blue-500 */
            cursor: pointer;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 9999px;
        }
        .control-panel-grid {
            grid-template-columns: 1fr 2fr;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-gray-800 p-3 text-center shadow-lg z-20">
        <h1 class="text-xl font-bold">Panorama Planner</h1>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col relative overflow-hidden">
        <!-- Camera Viewport -->
        <div id="camera-viewport" class="relative w-full flex-grow bg-black flex items-center justify-center">
            <video id="camera-feed" playsinline autoplay class="w-full h-full object-cover"></video>
            <canvas id="overlay-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
            <div id="permission-message" class="absolute inset-0 bg-gray-900 bg-opacity-80 p-4 text-center flex-col justify-center items-center hidden">
                <p class="text-lg">Waiting for camera permission...</p>
                <p class="text-sm text-gray-400 mt-2">Please allow camera access to use this app. If you denied it, you may need to reset permissions in your browser settings.</p>
            </div>
        </div>

        <!-- Controls Panel -->
        <div id="controls-panel" class="bg-gray-800 p-4 space-y-4 z-10 overflow-y-auto">
            <!-- Sensor Size -->
            <div class="grid control-panel-grid items-center gap-2">
                <label for="sensor-size" class="text-sm font-medium">Sensor Size</label>
                <select id="sensor-size" class="bg-gray-700 border border-gray-600 rounded-lg p-2 text-sm w-full">
                    <option value="phone">Phone (1/2.55")</option>
                    <option value="apsc">APS-C</option>
                    <option value="fullframe" selected>Full-Frame</option>
                    <option value="micro43">Micro 4/3</option>
                </select>
            </div>

            <!-- Focal Length -->
            <div class="grid control-panel-grid items-center gap-2">
                <label for="focal-length" class="text-sm font-medium">Focal Length</label>
                <div class="flex items-center space-x-2">
                    <input type="range" id="focal-length" min="12" max="200" value="50" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                    <span id="focal-length-value" class="text-sm font-mono w-12 text-center">50mm</span>
                </div>
            </div>

            <!-- Overlap -->
            <div class="grid control-panel-grid items-center gap-2">
                <label for="overlap" class="text-sm font-medium">Overlap</label>
                <div class="flex items-center space-x-2">
                    <input type="range" id="overlap" min="10" max="50" value="30" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                    <span id="overlap-value" class="text-sm font-mono w-12 text-center">30%</span>
                </div>
            </div>

            <!-- Panel Count -->
            <div class="grid control-panel-grid items-center gap-2">
                <label for="panel-count" class="text-sm font-medium">Panels</label>
                <div class="flex items-center space-x-2">
                    <input type="range" id="panel-count" min="2" max="15" value="5" class="w-full h-2 rounded-lg appearance-none cursor-pointer">
                    <span id="panel-count-value" class="text-sm font-mono w-12 text-center">5</span>
                </div>
            </div>

            <!-- Orientation -->
            <div class="grid control-panel-grid items-center gap-2">
                <label class="text-sm font-medium">Orientation</label>
                <div class="flex rounded-lg bg-gray-700 p-1">
                    <button id="orientation-landscape" class="w-full bg-blue-500 text-white rounded-md py-1 px-3 text-sm font-semibold">Landscape</button>
                    <button id="orientation-portrait" class="w-full text-gray-300 rounded-md py-1 px-3 text-sm">Portrait</button>
                </div>
            </div>

             <!-- Result Display -->
            <div class="bg-gray-900 rounded-lg p-3 text-center">
                <p class="text-sm text-gray-400">Calculated Panorama FOV</p>
                <p id="pano-fov-value" class="text-2xl font-bold text-blue-400">105.4°</p>
            </div>


            <!-- Action Button -->
            <button id="capture-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                Lock Plan & Capture Guide
            </button>
        </div>

        <!-- Guide Panel -->
        <div id="guide-panel" class="absolute inset-0 bg-gray-900 p-4 z-20 flex-col items-center justify-center text-center hidden">
            <h2 class="text-lg font-bold mb-4">Panorama Guide</h2>
            <p class="text-sm mb-2">This is the **first** shot in your sequence.</p>
            <p class="text-sm text-gray-400 mb-4">For your next shot, pan right until the left edge of your camera view matches this guide image.</p>
            <canvas id="guide-canvas" class="border-2 border-blue-500 rounded-lg max-w-full"></canvas>
            <button id="reset-button" class="mt-6 w-full max-w-xs bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                Plan New Panorama
            </button>
        </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const video = document.getElementById('camera-feed');
            const overlayCanvas = document.getElementById('overlay-canvas');
            const overlayCtx = overlayCanvas.getContext('2d');
            const permissionMessage = document.getElementById('permission-message');

            const controlsPanel = document.getElementById('controls-panel');
            const sensorSelect = document.getElementById('sensor-size');
            const focalLengthSlider = document.getElementById('focal-length');
            const focalLengthValue = document.getElementById('focal-length-value');
            const overlapSlider = document.getElementById('overlap');
            const overlapValue = document.getElementById('overlap-value');
            const panelCountSlider = document.getElementById('panel-count');
            const panelCountValue = document.getElementById('panel-count-value');
            const landscapeBtn = document.getElementById('orientation-landscape');
            const portraitBtn = document.getElementById('orientation-portrait');
            const panoFovValue = document.getElementById('pano-fov-value');
            
            const captureButton = document.getElementById('capture-button');
            const guidePanel = document.getElementById('guide-panel');
            const guideCanvas = document.getElementById('guide-canvas');
            const guideCtx = guideCanvas.getContext('2d');
            const resetButton = document.getElementById('reset-button');
            
            // --- State and Constants ---
            const SENSOR_SIZES = {
                fullframe: { width: 36, height: 24 },
                apsc: { width: 23.6, height: 15.7 },
                micro43: { width: 17.3, height: 13 },
                phone: { width: 5.6, height: 4.2 } // Approx 1/2.55" sensor
            };
            
            let state = {
                orientation: 'landscape', // 'landscape' or 'portrait'
                stream: null,
            };

            // --- Camera Initialization ---
            async function startCamera() {
                permissionMessage.style.display = 'flex';
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    });
                    state.stream = stream;
                    video.srcObject = stream;
                    video.onloadedmetadata = () => {
                        permissionMessage.style.display = 'none';
                        video.play();
                        resizeCanvas();
                        requestAnimationFrame(updateCalculationsAndDraw);
                    };
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    permissionMessage.innerHTML = `<p class="text-lg text-red-500">Camera Access Denied</p><p class="text-sm text-gray-400 mt-2">Please enable camera permissions in your browser's settings and refresh the page.</p>`;
                }
            }
            
            function resizeCanvas() {
                const videoAspectRatio = video.videoWidth / video.videoHeight;
                const parentRect = video.parentElement.getBoundingClientRect();
                const parentAspectRatio = parentRect.width / parentRect.height;

                let canvasWidth, canvasHeight;

                if (videoAspectRatio > parentAspectRatio) {
                    canvasWidth = parentRect.width;
                    canvasHeight = parentRect.width / videoAspectRatio;
                } else {
                    canvasHeight = parentRect.height;
                    canvasWidth = parentRect.height * videoAspectRatio;
                }
                
                overlayCanvas.width = canvasWidth;
                overlayCanvas.height = canvasHeight;
            }

            window.addEventListener('resize', resizeCanvas);


            // --- Calculation Engine ---
            function calculateSingleFOV(sensorDimension, focalLength) {
                return 2 * Math.atan(sensorDimension / (2 * focalLength)) * (180 / Math.PI);
            }

            function updateCalculationsAndDraw() {
                // Read values from controls
                const sensor = SENSOR_SIZES[sensorSelect.value];
                const focalLength = parseInt(focalLengthSlider.value);
                const overlap = parseInt(overlapSlider.value) / 100;
                const panelCount = parseInt(panelCountSlider.value);

                // Update UI text values
                focalLengthValue.textContent = `${focalLength}mm`;
                overlapValue.textContent = `${overlap * 100}%`;
                panelCountValue.textContent = panelCount;
                
                // Perform calculations
                const sensorDimension = state.orientation === 'landscape' ? sensor.width : sensor.height;
                const singleFov = calculateSingleFOV(sensorDimension, focalLength);
                
                let panoFov = (singleFov * panelCount) - (singleFov * overlap * (panelCount - 1));
                
                // Adjust for video feed orientation if necessary
                const videoIsPortrait = video.videoHeight > video.videoWidth;
                const planningIsPortrait = state.orientation === 'portrait';

                // The FOV we see on screen corresponds to the video's WIDER dimension.
                let onScreenFov;
                if(videoIsPortrait) {
                    onScreenFov = calculateSingleFOV(sensor.height, focalLength); // Phone held vertically
                } else {
                    onScreenFov = calculateSingleFOV(sensor.width, focalLength); // Phone held horizontally
                }

                // If planning orientation doesn't match on-screen orientation, use the other dimension for calculation
                if (videoIsPortrait !== planningIsPortrait) {
                     const alternateDimension = state.orientation === 'landscape' ? sensor.width : sensor.height;
                     onScreenFov = calculateSingleFOV(alternateDimension, focalLength);
                }


                panoFovValue.textContent = `${panoFov.toFixed(1)}°`;

                // Draw the overlay
                drawOverlay(onScreenFov, panoFov, panelCount, overlap);
                
                if (state.stream) {
                   requestAnimationFrame(updateCalculationsAndDraw);
                }
            }
            
            // --- Drawing Logic ---
            function drawOverlay(singleFov, panoFov, panelCount, overlap) {
                overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

                const pixelsPerDegree = overlayCanvas.width / singleFov;
                const panoWidth = panoFov * pixelsPerDegree;
                const panelWidthNoOverlap = singleFov * (1 - overlap) * pixelsPerDegree;

                const startX = (overlayCanvas.width - panoWidth) / 2;
                
                // Draw main panorama bounding box
                overlayCtx.fillStyle = 'rgba(59, 130, 246, 0.2)'; // blue-500 with opacity
                overlayCtx.strokeStyle = 'rgba(59, 130, 246, 0.8)';
                overlayCtx.lineWidth = 3;
                overlayCtx.fillRect(startX, 0, panoWidth, overlayCanvas.height);
                overlayCtx.strokeRect(startX, 0, panoWidth, overlayCanvas.height);
                
                // Draw panel dividers
                overlayCtx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
                overlayCtx.lineWidth = 1;
                overlayCtx.setLineDash([5, 5]);

                for (let i = 1; i < panelCount; i++) {
                    const lineX = startX + (i * panelWidthNoOverlap);
                    overlayCtx.beginPath();
                    overlayCtx.moveTo(lineX, 0);
                    overlayCtx.lineTo(lineX, overlayCanvas.height);
                    overlayCtx.stroke();
                }
                overlayCtx.setLineDash([]);
            }

            // --- Capture Logic ---
            function captureGuide() {
                controlsPanel.classList.add('hidden');
                guidePanel.style.display = 'flex';

                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);

                const overlapPercent = parseInt(overlapSlider.value) / 100;
                const overlapPixels = tempCanvas.width * overlapPercent;
                
                const sx = tempCanvas.width - overlapPixels;
                const sy = 0;
                const sWidth = overlapPixels;
                const sHeight = tempCanvas.height;

                guideCanvas.width = sWidth;
                guideCanvas.height = sHeight;

                guideCtx.drawImage(tempCanvas, sx, sy, sWidth, sHeight, 0, 0, guideCanvas.width, guideCanvas.height);
            }

            // --- Event Listeners ---
            [focalLengthSlider, overlapSlider, panelCountSlider, sensorSelect].forEach(el => {
                el.addEventListener('input', () => {
                    // This is just to trigger the animation frame, which reads the values
                });
            });

            landscapeBtn.addEventListener('click', () => {
                state.orientation = 'landscape';
                landscapeBtn.classList.add('bg-blue-500', 'text-white');
                landscapeBtn.classList.remove('text-gray-300');
                portraitBtn.classList.remove('bg-blue-500', 'text-white');
                portraitBtn.classList.add('text-gray-300');
            });
            
            portraitBtn.addEventListener('click', () => {
                state.orientation = 'portrait';
                portraitBtn.classList.add('bg-blue-500', 'text-white');
                portraitBtn.classList.remove('text-gray-300');
                landscapeBtn.classList.remove('bg-blue-500', 'text-white');
                landscapeBtn.classList.add('text-gray-300');
            });

            captureButton.addEventListener('click', captureGuide);
            
            resetButton.addEventListener('click', () => {
                guidePanel.style.display = 'none';
                controlsPanel.classList.remove('hidden');
            });
            
            // --- Start the app ---
            startCamera();
        });
    </script>
</body>
</html>
